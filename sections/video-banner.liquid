<style>
  /* Variables et Structure de base */
  #video-container-{{ section.id }} {
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: {{ section.settings.section_width }}px;
    height: {{ section.settings.desktop_height }}px;
    margin: {{ section.settings.top_margin }}px auto {{ section.settings.bottom_margin }}px;
    padding: {{ section.settings.vertical_padding }}px {{ section.settings.horizontal_padding }}px;
  }

  /* Media Queries Spacing */
  @media screen and (max-width: 768px) {
    #video-container-{{ section.id }} {
      height: {{ section.settings.mobile_height }}px;
    }
    .video-container .desktop-video { display: none !important; }
    .video-container .mobile-video { display: block !important; }
  }

  /* Vidéos Background */
  .video-container video, 
  .placeholder-video {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
    z-index: 0;
  }

  .video-container .mobile-video { display: none; }

  /* Overlay Sombre */
  .video-container::after {
    content: "";
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.15);
    z-index: 1;
    pointer-events: none;
  }

  /* Contenu Texte */
  .text-overlay {
    position: relative;
    z-index: 2;
    padding: 40px;
    width: 100%;
    color: #ffffff;
  }

  .text-overlay h1, .text-overlay h2, .text-overlay p {
    margin: 0 0 1.25rem;
    color: inherit;
  }

  .subheading {
    font-size: 0.85em;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  /* Bouton Stylisé */
  .text-overlay a.btn-custom {
    text-decoration: none;
    padding: 14px 28px;
    display: inline-block;
    transition: transform 0.3s ease, opacity 0.3s ease;
    background-image: url('{{ "shape-hexagone-stroke.svg" | asset_url }}');
    background-repeat: no-repeat;
    background-size: contain;
    background-position: center;
    font-family: "Poppins", sans-serif;
    font-weight: 600;
    color: #ffffff;
    
  }

  .text-overlay a.btn-custom:hover {
    background-image: url('{{ "shape-hexagone.svg" | asset_url }}');
    transform: scale(1.05);
  }

  /* Alignements */
  .video-container.top-left { justify-content: flex-start; align-items: flex-start; text-align: left; }
  .video-container.top-center { justify-content: flex-start; align-items: center; text-align: center; }
  .video-container.top-right { justify-content: flex-start; align-items: flex-end; text-align: right; }
  .video-container.middle-left { justify-content: center; align-items: flex-start; text-align: left; }
  .video-container.middle-center { justify-content: center; align-items: center; text-align: center; }
  .video-container.middle-right { justify-content: center; align-items: flex-end; text-align: right; }
  .video-container.bottom-left { justify-content: flex-end; align-items: flex-start; text-align: left; }
  .video-container.bottom-center { justify-content: flex-end; align-items: center; text-align: center; }
  .video-container.bottom-right { justify-content: flex-end; align-items: flex-end; text-align: right; }

  /* YouTube Iframe Fix */
  .iframe-holder { position: absolute; inset: 0; z-index: 0; pointer-events: none; overflow: hidden; }
  .iframe-container { width: 100%; height: 100%; position: relative; }
  .iframevideo {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100vw;
    height: 56.25vw; /* 16:9 ratio */
    min-height: 100vh;
    min-width: 177.77vh;
    transform: translate(-50%, -50%);
  }
</style>

<div id="video-container-{{ section.id }}" class="video-container {{ section.settings.content_position }}">
  {%- if section.settings.video_url != blank -%}
    <div class="iframe-holder">
      <div class="iframe-container">
        <div id="iframe-player-{{ section.id }}" videoLink="{{ section.settings.video_url | escape }}"></div>
      </div>
      {%- if section.settings.image_placeholder != blank -%}
        {{ section.settings.image_placeholder | image_url: width: 2000 | image_tag: class: 'placeholder-video', loading: 'lazy' }}
      {%- endif -%}
    </div>
  {%- elsif section.settings.video != blank or section.settings.video_mobile != blank -%}
    {%- if section.settings.video != blank -%}
      {{ section.settings.video | video_tag: autoplay: true, loop: true, muted: true, controls: false, class: 'desktop-video' }}
    {%- endif -%}
    {%- if section.settings.video_mobile != blank -%}
      {{ section.settings.video_mobile | video_tag: autoplay: true, loop: true, muted: true, controls: false, class: 'mobile-video' }}
    {%- endif -%}
  {%- else -%}
    {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-video' }}
  {%- endif -%}

  <div class="text-overlay">
    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when 'subheading' -%}
          <div class="subheading" {{ block.shopify_attributes }}>{{ block.settings.subheading_text }}</div>
        
        {%- when 'heading' -%}
          <style>
            #video-container-{{ section.id }} .heading-{{ block.id }} {
              font-size: {{ block.settings.desktop_heading_size }}px;
              max-width: {{ block.settings.desktop_width }}px;
              margin-inline: {% if section.settings.content_position contains 'center' %}auto{% elsif section.settings.content_position contains 'right' %}0 0{% else %}0 auto{% endif %};
            }
            @media (max-width: 768px) {
              #video-container-{{ section.id }} .heading-{{ block.id }} {
                font-size: {{ block.settings.mobile_heading_size }}px;
                max-width: {{ block.settings.mobile_width }}px;
              }
            }
          </style>
          {%- if block.settings.h1_heading -%}
            <h1 class="heading-{{ block.id }}">{{ block.settings.heading_text }}</h1>
          {%- else -%}
            <h2 class="heading-{{ block.id }}">{{ block.settings.heading_text }}</h2>
          {%- endif -%}

        {%- when 'text' -%}
          <div class="rich-text" {{ block.shopify_attributes }}>{{ block.settings.text_content }}</div>

        {%- when 'button' -%}
          <div class="btn-wrapper" {{ block.shopify_attributes }}>
            <a href="{{ block.settings.button_link }}" class="btn-custom">{{ block.settings.button_text }}</a>
          </div>
      {%- endcase -%}
    {%- endfor -%}
  </div>
</div>

<script>
  (function() {
    const videoId = (url) => {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : false;
    };

    const playerElement = document.querySelector('#iframe-player-{{ section.id }}');
    if (!playerElement) return;

    const link = videoId(playerElement.getAttribute('videoLink'));
    if (!link) return;

    if (!window.YT) {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    window.onYouTubeIframeAPIReady = window.onYouTubeIframeAPIReady || function() {
      new YT.Player('iframe-player-{{ section.id }}', {
        videoId: link,
        playerVars: { 'autoplay': 1, 'controls': 0, 'mute': 1, 'loop': 1, 'playlist': link, 'rel': 0, 'showinfo': 0 },
        events: {
          'onReady': (e) => { 
            e.target.playVideo();
            document.querySelector('#video-container-{{ section.id }} .placeholder-video')?.classList.add('video-played-hidden');
          },
          'onStateChange': (e) => { if (e.data === YT.PlayerState.ENDED) e.target.playVideo(); }
        }
      });
    };
  })();
</script>
{%- schema -%}
{
   "name":"Video Banner",
   "settings":[
      {
         "type":"video",
         "id":"video",
         "label":"Desktop video"
      },
      {
         "type":"video",
         "id":"video_mobile",
         "label":"Mobile video"
      },
      {
         "type":"header",
         "content":"Youtube video"
      },
      {
         "type":"text",
         "id":"video_url",
         "label":"Video URL",
         "info":"Enter the URL of a YouTube video."
      },
      {
         "type":"image_picker",
         "id":"image_placeholder",
         "label":"Place holder image"
      },
      {
         "type":"text",
         "id":"video-alt",
         "label":"Video description"
      },
      {
         "type":"header",
         "content":"Position and dimensions"
      },
      {
         "type":"select",
         "id":"content_position",
         "options":[
            {
               "value":"top-left",
               "label":"Top Left"
            },
            {
               "value":"top-center",
               "label":"Top Center"
            },
            {
               "value":"top-right",
               "label":"Top Right"
            },
            {
               "value":"middle-left",
               "label":"Middle Left"
            },
            {
               "value":"middle-center",
               "label":"Middle Center"
            },
            {
               "value":"middle-right",
               "label":"Middle Right"
            },
            {
               "value":"bottom-left",
               "label":"Bottom Left"
            },
            {
               "value":"bottom-center",
               "label":"Bottom Center"
            },
            {
               "value":"bottom-right",
               "label":"Bottom Right"
            }
         ],
         "default":"middle-center",
         "label":"Text Position"
      },
      {
         "type":"range",
         "id":"section_width",
         "min":800,
         "max":2000,
         "step":50,
         "unit":"px",
         "label":"Section Width",
         "default":1200
      },
      {
         "type":"range",
         "id":"desktop_height",
         "min":200,
         "max":1000,
         "step":20,
         "unit":"px",
         "label":"Desktop Height",
         "default":600
      },
      {
         "type":"range",
         "id":"mobile_height",
         "min":100,
         "max":1000,
         "step":20,
         "unit":"px",
         "label":"Mobile Height",
         "default":500
      },
      {
         "type":"header",
         "content":"Spacing"
      },
      {
         "type":"range",
         "id":"horizontal_padding",
         "min":0,
         "max":100,
         "step":5,
         "unit":"px",
         "label":"Horizontal Padding",
         "default":0
      },
      {
         "type":"range",
         "id":"vertical_padding",
         "min":0,
         "max":100,
         "step":5,
         "unit":"px",
         "label":"Vertical Padding",
         "default":0
      },
      {
         "type":"range",
         "id":"top_margin",
         "min":0,
         "max":100,
         "step":5,
         "unit":"px",
         "label":"Top Margin",
         "default":0
      },
      {
         "type":"range",
         "id":"bottom_margin",
         "min":0,
         "max":100,
         "step":5,
         "unit":"px",
         "label":"Bottom Margin",
         "default":0
      }
   ],
   "blocks":[
      {
         "type":"heading",
         "name":"Heading",
         "settings":[
            {
               "type":"text",
               "id":"heading_text",
               "label":"Heading Text",
               "default":"Banner Video"
            },
            {
               "type":"range",
               "id":"desktop_width",
               "min":100,
               "max":1000,
               "step":10,
               "unit":"px",
               "label":"Maximum desktop width",
               "default":1000
            },
            {
               "type":"range",
               "id":"mobile_width",
               "min":100,
               "max":1000,
               "step":10,
               "unit":"px",
               "label":"Maximum mobile width",
               "default":400
            },
            {
               "type":"range",
               "id":"desktop_heading_size",
               "min":20,
               "max":150,
               "step":2,
               "unit":"px",
               "label":"Desktop heading size",
               "default":84
            },
            {
               "type":"range",
               "id":"mobile_heading_size",
               "min":20,
               "max":150,
               "step":2,
               "unit":"px",
               "label":"Mobile heading size",
               "default":32
            },
            {
               "type": "checkbox",
               "id": "h1_heading",
               "label": "Set as an h1 heading",
               "default": false
            }
         ]
      },
      {
         "type":"subheading",
         "name":"Subheading",
         "settings":[
            {
               "type":"text",
               "id":"subheading_text",
               "label":"Subheading Text",
               "default":"YOUR SUBHEADING"
            }
         ]
      },
      {
         "type":"text",
         "name":"Text",
         "settings":[
            {
               "type":"richtext",
               "id":"text_content",
               "label":"Text Content",
               "default":"<p>Your text goes here</p>"
            }
         ]
      },
      {
         "type":"button",
         "name":"Button",
         "settings":[
            {
               "type":"text",
               "id":"button_text",
               "label":"Button Text",
               "default":"CLICK HERE"
            },
            {
               "type": "url",
               "id": "button_link",
               "label": "Button link",
               "default":"/"
            },
            {
               "type":"color",
               "id":"button_text_color",
               "label":"Button Text Color",
               "default":"#ffffff"
            },
            {
               "type":"color",
               "id":"button_bg_color",
               "label":"Button background color (for hover)",
               "default":"#000000"
            },
            {
               "type":"color",
               "id":"button_bg_hover",
               "label":"Button hover color (unused)",
               "default":"#232323"
            },
            {
               "type":"range",
               "id":"button_radius",
               "min":0,
               "max":40,
               "step":2,
               "unit":"px",
               "label":"Corner radius",
               "default":0
            },
            {
               "type": "checkbox",
               "id": "font_weight",
               "label": "Make button text bold",
               "default": false
            },
            {
               "type":"range",
               "id":"font_size",
               "min":0,
               "max":30,
               "step":1,
               "unit":"px",
               "label":"Button text size",
               "default":15
            }
         ]
      }
   ],
   "presets":[
      {
         "name":"Video Banner",
         "category":"Media",
         "blocks": [
            {
               "type": "subheading"
            },
            {
               "type": "heading"
            },
            {
               "type": "text"
            },
            {
               "type": "button"
            }
         ]
      }
   ]
}
{%- endschema -%}
